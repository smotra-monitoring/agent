# OpenAPI Code Generation

This document explains how OpenAPI types are generated and how to maintain them when using reusable response components.

## Overview

The project uses `omg` (OpenAPI Model Generator) to generate Rust types from the OpenAPI specification at [api/openapi/api/spec.yaml](../../api/openapi/api/spec.yaml). Generated code is placed in [src/openapi/omg/generated/](../../src/openapi/omg/generated/) and re-exported through [src/openapi/](../../src/openapi/).

## Architecture Decision: Reusable Response Components

The OpenAPI spec uses **reusable response components** (defined in `components/responses`) for common HTTP responses like `BadRequest`, `Unauthorized`, `NotFound`, etc. This is a best practice that:

- Reduces duplication across endpoints
- Ensures consistency in error responses
- Makes the spec easier to maintain
- Follows DRY principles

Example in the spec:
```yaml
paths:
  /agent/claim:
    post:
      responses:
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
```

## The Problem with `omg`

The `omg` code generator has a limitation: it only generates response wrapper types (e.g., `ClaimAgentResponse400`) for **inline response definitions**, not for responses referenced via `$ref: '#/components/responses/...'`.

This means:
- ✅ Generates: `ClaimAgentResponse403` (inline definition)
- ❌ Doesn't generate: `ClaimAgentResponse400` (uses reusable component)

## Our Solution

We maintain **two types of generated code**:

1. **Auto-generated** (`models.rs`, `mod.rs`): Generated by `omg` from the OpenAPI spec
2. **Manually maintained** (`responses.rs`): Custom response wrapper types for reusable components

### File Structure

```
src/openapi/
├── mod.rs              # Module entry, re-exports from omg
└── omg/
    ├── mod.rs          # Generated by omg, then modified to include responses module
    ├── responses.rs    # Manually maintained response types for reusable components
    └── generated/
        ├── mod.rs      # Fully auto-generated by omg
        └── models.rs   # Fully auto-generated schemas and inline response types
```

### The `responses.rs` File

This file defines response wrapper types that correspond to reusable response components:

```rust
/// Bad request - Invalid parameters
/// Corresponds to: `#/components/responses/BadRequest`
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ClaimAgentResponse400 {
    pub body: Error,
}
```

These types mirror the structure that `omg` would generate if the responses were defined inline.

## Regeneration Workflow

### Automated (Recommended)

Use the provided script:

```bash
just generate-omg
```

### Manual

If you need to regenerate manually:

```bash
# 1. Generate types
omg --input ./api/openapi/api/spec.yaml -o ./src/openapi/omg/generated/

# 2. Add responses module to mod.rs
echo "pub mod responses;" >> ./src/openapi/omg/mod.rs

# 3. Verify compilation
cargo check --lib
```

## When to Update `responses.rs`

You need to manually update `responses.rs` when:

1. **Adding a new endpoint** that references reusable response components
2. **Adding new reusable response components** in the OpenAPI spec

### Example: Adding a New Endpoint

If you add an endpoint that uses reusable responses:

```yaml
/agent/status:
  get:
    responses:
      '200':
        # Inline - omg will generate StatusResponse200
        description: Status retrieved
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentStatus'
      '400':
        # Reusable - need to add StatusResponse400 to responses.rs
        $ref: '#/components/responses/BadRequest'
      '401':
        # Reusable - need to add StatusResponse401 to responses.rs
        $ref: '#/components/responses/Unauthorized'
```

Add to `responses.rs`:

```rust
/// Bad request - Invalid parameters for GET /agent/status
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StatusResponse400 {
    pub body: Error,
}

/// Unauthorized - Invalid or missing authentication for GET /agent/status
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StatusResponse401 {
    pub body: Error,
}
```

### Naming Convention

Response wrapper types follow the pattern:
```
{OperationId}Response{StatusCode}
```

Where:
- `OperationId`: The `operationId` from the OpenAPI spec (e.g., `claimAgent` → `ClaimAgent`)
- `StatusCode`: The HTTP status code (e.g., `400`, `401`)

Examples:
- `ClaimAgentResponse400` for 400 response of `claimAgent` operation
- `GetAgentStatusResponse401` for 401 response of `getAgentStatus` operation

## Alternative Approaches Considered

### 1. Inline All Responses
**Rejected**: Would violate DRY principles and make the OpenAPI spec harder to maintain.

### 2. Different Code Generator
**Considered**: Other tools like `openapi-generator` might handle this differently, but they have other limitations and would require migration.

### 3. Post-processing Script
**Considered**: Could automatically generate `responses.rs` from the spec, but adds complexity and `omg` doesn't expose the necessary metadata easily.

### 4. Current Approach ✅
**Chosen**: Hybrid approach balances:
- Clean, maintainable OpenAPI spec with reusable components
- Mostly automated code generation
- Minimal manual maintenance (only for new endpoints with reusable responses)
- Clear separation of concerns

## Troubleshooting

### Error: `type ClaimAgentResponse400 not found`

**Cause**: The type uses a reusable response component but hasn't been added to `responses.rs`.

**Fix**: Add the missing type to [src/openapi/omg/responses.rs](../../src/openapi/omg/responses.rs).

### Error: `unresolved import: omg::responses`

**Cause**: The `responses` module wasn't added to `mod.rs` after regeneration.

**Fix**: Add `pub mod responses;` to `src/openapi/omg/mod.rs`.

### Generated types are missing

**Cause**: `omg` may have failed or the output path is incorrect.

**Fix**: Check that:
1. The OpenAPI spec is valid: `omg --input ./api/openapi/api/spec.yaml --output /tmp/test`
2. The output directory exists: `ls -la src/openapi/omg/generated/`
3. Run the regeneration script: `just generate-omg`

## Future Improvements

Potential improvements to consider:

1. **Automated Response Type Generation**: Create a script that parses the OpenAPI spec and auto-generates `responses.rs` by finding all operation responses that reference `components/responses/*`.

2. **CI Validation**: Add a CI check that verifies all reusable response references have corresponding types in `responses.rs`.

3. **Custom `omg` Fork**: Contribute to or fork `omg` to support reusable response component type generation.

4. **Macro-based Generation**: Use Rust macros to reduce boilerplate in `responses.rs`.
